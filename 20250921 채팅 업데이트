 
0) DB 스키마 (먼저)
	1.	테이블 생성 SQL
	•	message_threads (스레드/대화)
	•	message_participants (참여자/읽음/보관)
	•	messages (개별 메시지)
	2.	(선택) 인덱스/포린키 설정 점검

⸻

1) 공용 유틸 & 보안
	1.	공용 헬퍼 /lib/messages.php
	•	스레드 생성/참여자 추가/권한검증/조회 함수
	2.	CSRF /auth/csrf.php (있으면 재사용)
	3.	권한 /auth/guard.php (있으면 재사용; 없으면 최소 require_login(), require_role())

⸻

2) 액션(POST 전용)
	1.	새 대화 시작 /message_start.php ##
	•	입력: recipient_id 또는 product_id/order_id → 수신자 자동결정
	•	생성: thread + participants(2명) + 첫 메시지(body) → 리다이렉트
	2.	답장 전송 /message_send.php ##
	•	입력: thread_id, body
	•	권한: 참여자 여부 확인 → 메시지 INSERT → 리다이렉트
	3.	(선택) 보관/삭제/읽음처리 /message_action.php ##
	•	archive, mark_read 등

⸻

3) 고객용 화면 (My)
	1.	쪽지함 목록 /my_messages.php ##
	•	내가 참여자인 thread 목록 + 최근 메시지 스니펫 + 미읽음 뱃지
	2.	쪽지 상세 /my_message_view.php ##
	•	thread + 전체 메시지
	•	페이지 진입 시 last_read_at 업데이트
	•	하단 답장 폼

⸻

4) 파트너용 화면 (Partner)
	1.	쪽지함 목록 /partner/messages.php ##
	2.	쪽지 상세 /partner/message_view.php ##
	•	권한/참여자 검증 + 답장 폼

⸻

5) 진입 버튼/링크 추가(기존 페이지 수정)
	1.	헤더 메뉴 /partials/header.php ##
	•	로그인 상태에 따라 쪽지함 링크 추가
	•	고객: /my_messages.php ##
	•	파트너: /partner/messages.php ##
	2.	상품 상세 /product.php ##
	•	“파트너에게 문의하기” 버튼 → /message_start.php?product_id=XX
	•	(파트너 본인 상품은 버튼 숨김)
	3.	(선택) 주문 상세/마이페이지 /my.php ##
	•	“주문 관련 문의하기” 버튼 → /message_start.php?order_id=XX

⸻

6) i18n 키 추가(메시지 UI) ##
	•	nav.messages, messages.inbox, messages.sent, messages.empty, messages.reply, messages.send, messages.to_partner, messages.subject, messages.message, messages.last_message_at, messages.unread, product.message_partner …

⸻

7) 프론트/UX 디테일
	1.	목록 행: 상대방 이름/상품명/최근시간/미읽음 뱃지
	2.	상세: 본인 말풍선 우측 정렬, 상대방 좌측 정렬
	3.	긴 메시지 줄바꿈/링크 자동화(기본은 nl2br(htmlspecialchars()))
	4.	페이지네이션(선택)

⸻

8) 보안/검증
	1.	모든 POST에 CSRF 토큰
	2.	참여자만 스레드 접근 가능 (thread_id + user_id 검증)
	3.	입력 길이 제한, XSS 이스케이프
	4.	(선택) 플러딩 방지(초당/분당 레이트리밋)

⸻

9) 테스트 시나리오
	1.	고객 → 상품 상세에서 파트너에게 첫 메시지 전송
	2.	파트너 쪽지함에서 수신/읽음/답장 확인
	3.	고객 쪽지함에서 미읽음 → 읽음 전환 확인
	4.	주문 관련 시작 버튼도 동일하게 확인
	5.	권한 위반(타인 스레드 접근) 차단 확인

⸻
 